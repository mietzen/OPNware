---
- name: Build CaddyV2
  hosts: localhost
  gather_facts: false
  vars:
    gh_ws: "{{ lookup('env', 'GITHUB_WORKSPACE',) }}"
    repo: 'caddyserver/caddy'
    caddy_plugins:
      - github.com/caddy-dns/porkbun
      - github.com/caddy-dns/ddnss
      - github.com/mietzen/caddy-dynamicdns-cmd-source
  tasks:
    - name: Create Directories
      ansible.builtin.file:
        path: "{{ gh_ws }}/dist"
        state: directory
        mode: '0755'

    - name: Get latest release of a public repository
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          curl -s https://api.github.com/repos/{{ repo }}/releases/latest | jq -r '.tag_name'
        executable: /bin/bash
      register: latest_release
      changed_when: latest_release.rc != 0

    - name: Install xCaddy
      ansible.builtin.shell:
        cmd: |
          go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest
          which go
        creates: "{{ lookup('env', 'GOBIN',) }}/xcaddy"

    - name: Build CaddyV2
      ansible.builtin.shell:
        cmd: |
          xcaddy build {{ latest_release.stdout }} \
              --with {{ caddy_plugins | join(' --with ') }} \
              --output $GITHUB_WORKSPACE/dist
        creates: "{{ gh_ws }}/dist/caddy"
      environment:
        GOOS: freebsd
        GOARCH: "{{ lookup('env', 'ARCH',) }}"
