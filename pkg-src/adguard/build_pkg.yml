---
- name: Build AdGuardHome
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Create Directories
      ansible.builtin.file:
        path: "{{ lookup('env', 'GITHUB_WORKSPACE',) }}/dist"
        state: directory
        mode: '0755'

    - name: Install snapcraft
      ansible.builtin.command:
        cmd: snap install snapcraft --classic
        creates: "/snap/bin/snapcraft"
      become: true

    - name: Get latest release of a public repository
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          curl -s https://api.github.com/repos/${{ repo }}/releases/latest | jq -r '.tag_name'
      register: latest_release
      changed_when: latest_release.rc != 0
      vars:
        repo: 'AdguardTeam/AdGuardHome'

    - name: Git checkout repository
      ansible.builtin.git:
        repo: 'https://github.com/${{ repo }}.git'
        dest: "{{ lookup('env', 'GITHUB_WORKSPACE',) }}/src"
        version: "{{ latest_release.stdout }}"
      vars:
        repo: 'AdguardTeam/AdGuardHome'

    - name: Build AdGuardHome
      community.general.make:
        chdir: "{{ lookup('env', 'GITHUB_WORKSPACE',) }}/src"
        target: build-release
        params:
          VERBOSE: 1
          CHANNEL: release
          SIGN: 0
          VERSION: "{{ latest_release.tag }}"
          DIST_DIR: "../dist"
          ARCH: "{{ lookup('env', 'ARCH',) }}"
          OS: freebsd
