name: Main Workflow

on:
  workflow_dispatch:
  push:
    paths:
      - '!pkgs/**'
      - 'config.yml'
      - '.github/workflows/*.yml'
  schedule:
    - cron: "15 4 * * *"

jobs:
  discover-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Parse Packages and Config
        id: set-matrix
        run: |
          # Find all packages with both build_pkg.yml and manifest.yml
          pkgs=$(find pkgs -type f -name "build_pkg.yml" -exec dirname {} \; | xargs -n1 basename)

          # Read the abi and arch values from config.yml
          abi_list=$(yq eval '.pkg-repo.abi' config.yml | jq -c '.[]')
          arch_list=$(yq eval '.pkg-repo.arch' config.yml | jq -c '.[]')

          # Create the JSON matrix
          matrix=$(jq -n \
            --argjson abi_list "$abi_list" \
            --argjson arch_list "$arch_list" \
            --arg pkgs "$pkgs" \
            '{
              include: ($abi_list | map(. as $abi | $arch_list | map({abi: $abi, arch: ., pkgs: $pkgs})[])[])[]
            }')
          echo "Matrix: $matrix"
          echo "::set-output name=matrix::$matrix"

  build-packages:
    needs: discover-packages
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.discover-packages.outputs.matrix) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Call Build Workflows
        uses: ./.github/workflows/pkg_workflow_caller.yml
        with:
          abi: ${{ matrix.abi }}
          arch: ${{ matrix.arch }}
          pkg_name: ${{ matrix.pkgs }}
