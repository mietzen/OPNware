name: Main Workflow

on:
  workflow_dispatch:
  push:
    paths:
      - '!pkg-src/**'
      - 'config.yml'
      - '.github/workflows/*.yml'
  schedule:
    - cron: "15 4 * * *"

jobs:
  discover-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Parse Packages and Config
        id: set-matrix
        run: |
          # Find all packages with both build_pkg.yml and manifest.yml
          packages=$(find pkg-src -type f -name "build_pkg.yml" -exec dirname {} \; | xargs -n1 basename | sed -z '$ s/\n$//' | jq -Rsc 'split("\n")')

          # Read the abi and arch values from config.yml
          abi_list=$(yq eval '.pkg-repo.abi' config.yml -o json | jq -c)
          arch_list=$(yq eval '.pkg-repo.arch' config.yml -o json | jq -c)

          # Create the JSON matrix
          matrix=$(jq -n \
            --argjson arch "$arch_list" \
            --argjson abi "$abi_list" \
            --argjson pkg_name "$packages" \
            '{arch: $arch, abi: $abi, pkg_name: $pkg_name}')
          echo "Matrix: $matrix"
          echo "matrix=$matrix" >> $GITHUB_ENV

  build-packages:
    needs: discover-packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Call Build Workflows
        uses: ./.github/workflows/pkg_workflow_caller.yml
        with:
          matrix: ${{ needs.discover-packages.outputs.matrix }}
